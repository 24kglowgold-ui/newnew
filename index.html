<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡πÑ‡∏ó‡∏¢ - Thai Law Assistant</title>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-L248NH8B0M"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-L248NH8B0M'); 
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .chat-bubble-user {
            background-color: #3b82f6; /* Blue-500 */
            color: white;
            border-radius: 1.5rem 1.5rem 0.5rem 1.5rem;
        }
        .chat-bubble-ai {
            background-color: #ffffff;
            color: #1f2937; /* Gray-800 */
            border-radius: 1.5rem 1.5rem 1.5rem 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        /* Style for the Sponsored Card */
        .sponsored-card {
            background-color: #f0fdf4; /* Green-50 */
            border: 1px solid #bbf7d0; /* Green-200 */
            border-radius: 0.75rem;
            margin-top: 1rem;
            padding: 0.75rem;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <div class="w-full max-w-4xl bg-white rounded-xl shadow-2xl flex flex-col h-[90vh]">
        
        <header class="p-4 border-b bg-gray-50 rounded-t-xl flex justify-between items-center shadow-md">
            <h1 id="app-title" class="text-2xl font-bold text-gray-800">‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡πÑ‡∏ó‡∏¢</h1>
            
            <div class="flex items-center space-x-2">
                <label for="language-select" class="text-sm font-medium text-gray-600 hidden sm:block">‡∏†‡∏≤‡∏©‡∏≤:</label>
                <select id="language-select" class="p-2 rounded-lg border border-gray-300 bg-white shadow-inner focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out cursor-pointer text-sm">
                    <option value="thai">üáπüá≠ ‡πÑ‡∏ó‡∏¢ (Thai)</option>
                    <option value="english">üá∫üá∏ English</option>
                    <option value="chinese">üá®üá≥ ÁÆÄ‰Ωì‰∏≠Êñá (Simplified Chinese)</option>
                </select>
            </div>
        </header>

        <main id="chat-history" class="flex-grow overflow-y-auto p-6 space-y-4">
        </main>

        <footer class="p-4 border-t bg-gray-50 rounded-b-xl">
            <div id="paywall-container" class="hidden mb-4 p-4 bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 rounded-lg shadow-sm">
                <p id="paywall-text" class="font-bold mb-2 text-sm"></p>
                <button
                    id="pay-button"
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-150 transform hover:scale-105"
                >
                    Pay 50 THB for Unlimited Daily Access
                </button>
            </div>

            <button
                id="cta-button"
                class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 mb-3 rounded-xl shadow-lg transition duration-150 ease-in-out transform hover:scale-105"
                onclick="window.open('https://siamcenterlawgroup.com', '_blank')"
            >
                ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ó‡∏ô‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°
            </button>
            
            <div id="input-container" class="flex space-x-3">
                <input
                    type="text"
                    id="user-input"
                    class="flex-grow p-3 border border-gray-300 rounded-xl shadow-inner focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out"
                    placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏≤‡∏á‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì..."
                    autocomplete="off"
                >
                <button
                    id="send-button"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition duration-150 ease-in-out transform hover:scale-105 disabled:bg-gray-400 disabled:shadow-none"
                >
                    ‡∏™‡πà‡∏á
                </button>
            </div>
        </footer>
    </div>

    <div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl flex items-center space-x-3">
            <svg class="animate-spin h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span id="loading-text" class="text-gray-700 font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</span>
        </div>
    </div>

    <script>
        const proxyUrl = "/.netlify/functions/gemini-proxy";
        
        const chatHistory = document.getElementById('chat-history');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const languageSelect = document.getElementById('language-select');
        const appTitle = document.getElementById('app-title');
        const loadingModal = document.getElementById('loading-modal');
        const loadingText = document.getElementById('loading-text');
        const ctaButton = document.getElementById('cta-button'); 
        
        // Freemium References
        const paywallContainer = document.getElementById('paywall-container');
        const paywallText = document.getElementById('paywall-text');
        const payButton = document.getElementById('pay-button');
        const inputContainer = document.getElementById('input-container');

        // Sponsored Model: Assign user to a group (50/50 chance)
        const isSponsoredTestGroup = Math.random() < 0.5;

        const LANGUAGES = {
            'thai': {
                code: 'Thai', title: '‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡πÑ‡∏ó‡∏¢', placeholder: '‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏≤‡∏á‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...', sendButton: '‡∏™‡πà‡∏á', loading: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...', ctaButton: '‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏ô‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°',
                paywallMsg: "‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏ö 5 ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏ü‡∏£‡∏µ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß",
                verifiedTitle: "‡∏ó‡∏ô‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô",
                verifiedSub: "‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à 100% ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏ó‡∏±‡∏ô‡∏ó‡∏µ",
                greeting: "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞ ‡∏î‡∏¥‡∏â‡∏±‡∏ô‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡πÑ‡∏ó‡∏¢ ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏Ñ‡πà‡∏∞ ‡∏ó‡πà‡∏≤‡∏ô‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏î‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡πÑ‡∏ó‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏Ñ‡∏∞?",
                disclaimer: "**‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö:** ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£ ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ó‡∏ô‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÇ‡∏î‡∏¢‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏° '‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏ô‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°' ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á", 
                systemPrompt: "You are a highly specialized AI Legal Analyst focusing on Thai Law. Respond to the user's question with accuracy, utilizing search results for grounding. Your response must be generated entirely and clearly in the Thai language."
            },
            'english': {
                code: 'English', title: 'Thai Law Assistant', placeholder: 'Ask your legal question about Thai Law...', sendButton: 'Send', loading: 'Processing...', ctaButton: 'Contact a Lawyer',
                paywallMsg: "You've reached your limit of 5 free messages for today.",
                verifiedTitle: "Verified Lawyer Recommendation",
                verifiedSub: "Want 100% certainty? Consult a verified professional now.",
                greeting: "Hello! I am the Thai Law Assistant, an expert in Thai law ready to provide information and initial guidance. Do you have any questions regarding Thai law?",
                disclaimer: "**Disclaimer:** This is not formal legal advice. Please contact a lawyer professional for actual legal advice by clicking the 'Contact a Lawyer' button below.", 
                systemPrompt: "You are a highly specialized AI Legal Analyst focusing on Thai Law. Respond to the user's question with accuracy, utilizing search results for grounding. Your response must be generated entirely and clearly in the English language."
            },
            'chinese': {
                code: 'Simplified Chinese', title: 'Ê≥∞ÂõΩÊ≥ïÂæãÂä©ÁêÜ', placeholder: 'ËæìÂÖ•ÊÇ®ÁöÑÊ≥ïÂæãÈóÆÈ¢ò...', sendButton: 'ÂèëÈÄÅ', loading: 'Ê≠£Âú®Â§ÑÁêÜ...', ctaButton: 'ËÅîÁ≥ªÂæãÂ∏à',
                paywallMsg: "ÊÇ®‰ªäÂ§©Â∑≤ËææÂà∞ 5 Êù°ÂÖçË¥πÊ∂àÊÅØÁöÑ‰∏äÈôê„ÄÇ",
                verifiedTitle: "ËÆ§ËØÅÂæãÂ∏àÊé®Ëçê",
                verifiedSub: "ÊÉ≥Ë¶Å 100% ÁöÑÁ°ÆÂÆöÊÄßÂêóÔºüÁ´ãÂç≥Âí®ËØ¢ËÆ§ËØÅ‰∏ì‰∏ö‰∫∫Â£´„ÄÇ",
                greeting: "ÊÇ®Â•ΩÔºÅÊàëÊòØÊ≥∞ÂõΩÊ≥ïÂæãÂä©ÁêÜÔºå‰∏Ä‰ΩçÊ≥∞Ê≥ïÂæã‰∏ìÂÆ∂ÔºåÈöèÊó∂ÂáÜÂ§á‰∏∫ÊÇ®Êèê‰æõ‰ø°ÊÅØ‡πÅ‡∏•‡∏∞ÂàùÊ≠•ÊåáÂØº„ÄÇÊÇ®ÂØπÊ≥∞ÂõΩÊ≥ïÂæãÊúâ‰ªÄ‰πàÁñëÈóÆÂêóÔºü",
                disclaimer: "**ÂÖçË¥£Â£∞ÊòéÔºö** Êú¨‰ø°ÊÅØÂπ∂ÈùûÊ≠£ÂºèÊ≥ïÂæãÂª∫ËÆÆ„ÄÇÂ¶ÇÈúÄÂÆûÈôÖÊ≥ïÂæãÂª∫ËÆÆÔºåËØ∑ÁÇπÂáª‰∏ãÊñπÁöÑ‚ÄúËÅîÁ≥ªÂæãÂ∏à‚ÄùÊåâÈíÆËÅîÁ≥ª‰∏ì‰∏öÂæãÂ∏à„ÄÇ", 
                systemPrompt: "You are a highly specialized AI Legal Analyst focusing on Thai Law. Respond to the user's question with accuracy, utilizing search results for grounding. Your response must be generated entirely and clearly in the Simplified Chinese language (ÁÆÄ‰Ωì‰∏≠Êñá)."
            }
        };

        let currentLanguage = languageSelect.value;
        let chatHistoryArray = [];
        const MESSAGE_LIMIT = 5;
        let messageCount = 0;

        function displayInitialGreeting() {
            chatHistory.innerHTML = ''; 
            const lang = LANGUAGES[currentLanguage]; 
            addMessage('ai', lang.greeting);
            chatHistoryArray = []; 
            chatHistoryArray.push({ role: "model", parts: [{ text: lang.greeting }] });
        }

        function updateUI() {
            const lang = LANGUAGES[currentLanguage];
            appTitle.textContent = lang.title;
            userInput.placeholder = lang.placeholder;
            sendButton.textContent = lang.sendButton;
            loadingText.textContent = lang.loading;
            ctaButton.textContent = lang.ctaButton;
            paywallText.textContent = lang.paywallMsg;
        }

        function showPaywall() {
            paywallContainer.classList.remove('hidden');
            inputContainer.classList.add('hidden');
            if (typeof gtag === 'function') {
                gtag('event', 'usage_limit_reached', { 'event_category': 'Freemium_Test', 'event_label': LANGUAGES[currentLanguage].code });
            }
        }

        function addMessage(sender, text, sources = []) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = sender === 'user' ? 'flex justify-end' : 'flex justify-start';

            const messageBubble = document.createElement('div');
            messageBubble.className = sender === 'user' 
                ? 'chat-bubble-user p-4 max-w-3xl break-words whitespace-pre-wrap' 
                : 'chat-bubble-ai p-4 max-w-3xl break-words whitespace-pre-wrap';
            
            if (sender === 'ai') {
                const header = document.createElement('p');
                header.className = 'font-semibold text-blue-600 mb-1';
                header.textContent = `${LANGUAGES[currentLanguage].title}:`;
                messageBubble.appendChild(header);
            }

            const textContent = document.createElement('p');
            textContent.innerHTML = text.replace(/\n/g, '<br>');
            messageBubble.appendChild(textContent);

            if (sender === 'ai' && sources.length > 0) {
                const sourcesList = document.createElement('div');
                sourcesList.className = 'mt-3 pt-3 border-t border-gray-100 text-xs text-gray-500';
                const sourcesLabel = LANGUAGES[currentLanguage].code === 'Thai' ? '‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤' : LANGUAGES[currentLanguage].code === 'Simplified Chinese' ? 'Êù•Ê∫ê' : 'Sources';
                sourcesList.innerHTML = `<p class="font-medium mb-1">${sourcesLabel}:</p>`;
                sources.slice(0, 3).forEach((source, index) => {
                    const sourceLink = document.createElement('a');
                    sourceLink.href = source.uri; sourceLink.target = '_blank';
                    sourceLink.className = 'block hover:text-blue-600 truncate';
                    sourceLink.textContent = `${index + 1}. ${source.title || source.uri}`;
                    sourcesList.appendChild(sourceLink);
                });
                messageBubble.appendChild(sourcesList);
            }
            
            if (sender === 'ai') {
                // Disclaimer
                const disclaimerDiv = document.createElement('div');
                disclaimerDiv.className = 'mt-4 pt-3 border-t border-red-200 text-xs text-red-700 italic font-medium'; 
                disclaimerDiv.innerHTML = LANGUAGES[currentLanguage].disclaimer.replace(/\n/g, '<br>');
                messageBubble.appendChild(disclaimerDiv);

                // --- Sponsored Model Implementation ---
                // Show to 50% of users, and only for non-greeting AI messages (after first user query)
                if (isSponsoredTestGroup && messageCount > 0) {
                    const lang = LANGUAGES[currentLanguage];
                    const sponsorCard = document.createElement('div');
                    sponsorCard.className = 'sponsored-card cursor-pointer hover:bg-green-100 transition duration-150';
                    sponsorCard.innerHTML = `
                        <div class="flex items-center space-x-2 mb-1">
                            <span class="text-[10px] font-bold uppercase tracking-wider bg-green-200 text-green-800 px-1.5 py-0.5 rounded">Sponsored</span>
                            <span class="text-sm font-bold text-green-900">${lang.verifiedTitle}</span>
                        </div>
                        <p class="text-xs text-green-700">${lang.verifiedSub}</p>
                    `;
                    
                    sponsorCard.onclick = () => {
                        if (typeof gtag === 'function') {
                            gtag('event', 'verified_sponsor_click', {
                                'event_category': 'Sponsorship_Test',
                                'event_label': lang.code
                            });
                        }
                        window.open('https://siamcenterlawgroup.com', '_blank');
                    };
                    messageBubble.appendChild(sponsorCard);
                }
            }

            messageWrapper.appendChild(messageBubble);
            chatHistory.appendChild(messageWrapper);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        async function fetchWithRetry(payload, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(proxyUrl, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`Proxy failed: ${response.status}`);
                    return await response.json();
                } catch (error) {
                    if (i === retries - 1) throw error;
                    await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
                }
            }
        }

        async function sendQuery() {
            if (messageCount >= MESSAGE_LIMIT) {
                showPaywall();
                return;
            }

            const userQuery = userInput.value.trim();
            if (userQuery === "") return;

            messageCount++;

            if (typeof gtag === 'function') {
                gtag('event', 'chat_query_sent', {
                    'event_category': 'Chat_Interaction',
                    'event_label': LANGUAGES[currentLanguage].code,
                    'message_number': messageCount
                });
            }

            addMessage('user', userQuery);
            userInput.value = '';
            sendButton.disabled = true;
            userInput.disabled = true;
            loadingModal.classList.remove('hidden');

            const payload = {
                contents: [...chatHistoryArray, { role: "user", parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: LANGUAGES[currentLanguage].systemPrompt }] }
            };

            try {
                const result = await fetchWithRetry(payload);
                const candidate = result.candidates?.[0];
                let aiResponseText = "An error occurred.";
                let sources = [];

                if (candidate?.content?.parts?.[0]?.text) {
                    aiResponseText = candidate.content.parts[0].text;
                    if (candidate.groundingMetadata?.groundingAttributions) {
                        sources = candidate.groundingMetadata.groundingAttributions.map(a => ({ uri: a.web?.uri, title: a.web?.title }));
                    }
                }
                
                chatHistoryArray.push({ role: "user", parts: [{ text: userQuery }] });
                chatHistoryArray.push({ role: "model", parts: [{ text: aiResponseText }] });
                addMessage('ai', aiResponseText, sources);

                if (messageCount >= MESSAGE_LIMIT) {
                    showPaywall();
                }

            } catch (error) {
                addMessage('ai', "Connection error. Please try again.");
            } finally {
                loadingModal.classList.add('hidden');
                if (messageCount < MESSAGE_LIMIT) {
                    sendButton.disabled = false;
                    userInput.disabled = false;
                    userInput.focus();
                }
            }
        }

        payButton.addEventListener('click', () => {
            if (typeof gtag === 'function') {
                gtag('event', 'payment_intent_click', { 'event_category': 'Freemium_Test', 'event_label': LANGUAGES[currentLanguage].code });
            }
            window.open('https://docs.google.com/forms/d/e/1FAIpQLSdWgZUXz_EPi_h2b7Uyy855IViuky6h4TzXjJsx0rSK0eMalQ/viewform?usp=dialog', '_blank');
        });

        languageSelect.addEventListener('change', (e) => {
            currentLanguage = e.target.value;
            updateUI();
            displayInitialGreeting(); 
        });

        ctaButton.addEventListener('click', () => {
            if (typeof gtag === 'function') {
                gtag('event', 'contact_lawyer_click', { 'event_category': 'P1_Conversion', 'event_label': LANGUAGES[currentLanguage].code });
            }
        });

        sendButton.addEventListener('click', sendQuery);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !sendButton.disabled) sendQuery();
        });

        window.onload = () => {
            updateUI();
            displayInitialGreeting();
            userInput.focus();
        };
    </script>
</body>
</html>